<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èªè©ç·´ç¿’ï¼ˆå°ˆæ³¨ç‰ˆï¼‰</title>
  <style>
    :root { --gap: 14px; --radius: 16px; }
    html, body { height: 100%; }
    body {
      margin: 0; background: #f7f7f8;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", Arial, sans-serif;
      color: #0f172a; display:flex; align-items:center; justify-content:center;
    }
    .app {
      width: min(920px, 92vw); background: #fff; border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(2,6,23,.08); padding: clamp(16px, 3vw, 28px);
    }
    .top {
      display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: clamp(10px, 2vw, 16px);
    }
    .badge { font-size: 14px; padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 999px; background:#f8fafc; }
    .score { font-size: 14px; color:#334155; }
    .word {
      font-size: clamp(36px, 6vw, 60px); text-align:center; padding: clamp(10px, 3vw, 20px) 8px;
      border-radius: 12px; border: 1px dashed #e5e7eb; background: #fcfcfd; min-height: 1.6em;
    }
    .hint {
      text-align:center; color:#64748b; font-size: clamp(14px, 2.5vw, 16px); margin-top: 8px; min-height: 22px;
    }
    .controls {
      display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: clamp(16px, 3vw, 22px);
    }
    .btn {
      font-size: clamp(16px, 2.5vw, 18px); padding: clamp(12px, 2.8vw, 16px);
      border-radius: 12px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer;
      transition: transform .02s ease, background .2s ease;
      user-select: none;
    }
    .btn:active { transform: scale(.98); }
    .primary { background: #0ea5e9; color: #fff; border-color:#0ea5e9; }
    .ghost { background: #fff; }
    .danger { background: #ef4444; color:#fff; border-color:#ef4444; }
    .muted { color:#64748b; }
    .ok { color:#16a34a; }
    .bad{ color:#dc2626; }
    .bar { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 8px;}
    .left { display:flex; align-items:center; gap:10px; }
    .small { font-size: 13px; color:#6b7280; }
    .dotmenu { width:40px; height:40px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    .remain { font-size: 13px; color:#64748b; }
    /* dialog */
    dialog { width:min(900px, 92vw); border:none; border-radius: 16px; padding: 0; }
    .dlg { padding: 18px; }
    .dlg h2 { margin:0 0 8px; font-size: 18px; }
    .dlg .row { display:flex; flex-wrap:wrap; align-items:center; gap:10px; margin: 10px 0; }
    input[type="text"] { padding:10px 12px; border:1px solid #e5e7eb; border-radius:12px; font-size:14px; }
    textarea { width:100%; min-height: 90px; border:1px solid #e5e7eb; border-radius:12px; padding:10px; font-size:14px; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #e5e7eb; border-radius:999px; background:#f8fafc; cursor:pointer; }
    .pill + .pill { margin-left: 8px; }
    .sec { border-top:1px solid #eef2f7; padding-top: 12px; margin-top: 12px; }
    .close { position:absolute; right:10px; top:10px; width:40px; height:40px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; }
    details { border:1px solid #eef2f7; border-radius:12px; padding: 8px 12px; margin-bottom:10px; }
    summary { cursor:pointer; }
  </style>
</head>
<body>
  <div class="app">
    <div class="bar">
      <div class="left">
        <button id="bankBtn" class="badge">é¡Œåº«ï¼šæœªé¸æ“‡</button>
        <span class="remain">å‰©é¤˜ï¼š<b id="remaining">0</b></span>
      </div>
      <div class="score" id="score">é€šéç‡ï¼š0/0ï¼ˆ0%ï¼‰</div>
    </div>

    <div class="word" id="word">è«‹é¸æ“‡é¡Œåº«</div>
    <div class="hint" id="hint">æŒ‰ä¸‹ã€Œé–‹å§‹ã€å¾Œæ¸…æ¥šå¿µå‡ºè©èª</div>

    <div class="controls">
      <button id="startBtn" class="btn primary">é–‹å§‹</button>
      <button id="nextBtn"  class="btn ghost">ä¸‹ä¸€é¡Œ</button>
      <button id="moreBtn"  class="btn ghost">â‹¯</button>
    </div>
  </div>

  <!-- ç®¡ç†/é¸æ“‡ é¡Œåº« dialog -->
  <dialog id="bankDlg">
    <div class="dlg">
      <button class="close" id="dlgClose">âœ•</button>
      <h2>é¸æ“‡æˆ–ç®¡ç†é¡Œåº«</h2>
      <div class="row small">é»é¸ä¸‹æ–¹é¡Œåº«å³å¯åˆ‡æ›ï¼›å¯æ”¹åã€ç·¨è¼¯å…§å®¹æˆ–æ–°å¢é¡Œåº«ã€‚è³‡æ–™å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ã€‚</div>
      <div id="bankPills" class="row"></div>

      <div class="sec">
        <h2>é¡Œåº«å…§å®¹</h2>
        <div class="row">
          <input type="text" id="bankNameInput" placeholder="é¡Œåº«åç¨±" />
          <button id="saveNameBtn" class="btn ghost">å„²å­˜åç¨±</button>
          <button id="deleteBankBtn" class="btn danger">åˆªé™¤æ­¤é¡Œåº«</button>
        </div>
        <textarea id="bankText"></textarea>
        <div class="row">
          <button id="saveBankBtn" class="btn primary">å„²å­˜å…§å®¹</button>
          <button id="resetBankBtn" class="btn ghost">è¼‰å…¥é è¨­ï¼ˆè‹¥æœ‰ï¼‰</button>
          <span class="small">ä»¥ç©ºç™½ã€é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”</span>
        </div>
      </div>

      <div class="sec">
        <h2>æ–°å¢é¡Œåº«</h2>
        <div class="row">
          <input id="newBankName" type="text" placeholder="æ–°é¡Œåº«åç¨±ï¼ˆä¾‹å¦‚ï¼šG5L1 æˆ– ç¤¾æœƒæŠ€å·§Aï¼‰" />
          <button id="addBankBtn" class="btn primary">æ–°å¢</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- æ›´å¤šé¸é … dialog -->
  <dialog id="moreDlg">
    <div class="dlg">
      <button class="close" id="moreClose">âœ•</button>
      <h2>æ›´å¤š</h2>
      <div class="row">
        <button id="reshuffleBtn" class="btn ghost">é‡æ’æœ¬è¼ª</button>
        <button id="resetProgressBtn" class="btn ghost">é‡ç½®é€²åº¦</button>
        <button id="resetScoreBtn" class="btn danger">æ¸…ç©ºåˆ†æ•¸</button>
      </div>
      <div class="small">èªªæ˜ï¼šé‡æ’æœƒé‡æ–°æ´—ç‰Œï¼›é‡ç½®é€²åº¦æœƒå¾ç•¶å‰é¡Œåº«é‡æ–°é–‹å§‹ï¼›æ¸…ç©ºåˆ†æ•¸åªå½±éŸ¿ç›®å‰é¡Œåº«ã€‚</div>
    </div>
  </dialog>

  <script>
    // ======== é è¨­é¡Œåº«èˆ‡åç¨± ========
    const DEFAULT_BANKS = {
      b1: ["æ†‚æ„","ç¦®è®“","è¼‰äºº","ç‘æ°´","å°èˆŸ","æ–‡å­—","å­¸ç¿’","ç·´ç¿’","ç›¸ä¼¼","å£è¨£","å¿Œå¦’","å˜†æ°£"],
      b2: ["è€³æœµ","æºœå†°","ä¸€ä¸²","æ°´ç ","é’è›™","æ¸¸æ³³","ç…©æƒ±","è½‰èº«","é™€èº","ç·©æ…¢","æ»‘å€’","è€é·¹"]
    };
    const DEFAULT_NAMES = { b1: "G3L1", b2: "G4L1" };

    // localStorage keys
    const LS_BANKS = "speech_custom_banks_v2";
    const LS_NAMES = "speech_custom_names_v2";
    const LS_PROGRESS = "speech_progress_v2";
    const LS_SCORES = "speech_scores_v2";

    // ======== ç‹€æ…‹ ========
    let BANKS = load(LS_BANKS, DEFAULT_BANKS);
    let NAMES = load(LS_NAMES, DEFAULT_NAMES);
    let SCORES = load(LS_SCORES, {});
    let currentBankKey = null;
    let currentBank = [];
    let remaining = [];
    let currentWord = "";
    let listening = false;

    // ======== å·¥å…· ========
    function save(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
    function load(key, fallback){ try{ const s=localStorage.getItem(key); return s? JSON.parse(s): JSON.parse(JSON.stringify(fallback)); }catch(e){ return JSON.parse(JSON.stringify(fallback)); } }
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
    function splitWords(t){ return t.split(/[ï¼Œ,\u3000\s\n\r]+/).map(w=>w.trim()).filter(Boolean); }
    function normalize(s){ return (s||"").replace(/[\u3000\s]/g,"").replace(/[ã€‚ï¼Œï¼ã€ï¼›ï¼šï¼Ÿï¼â€¦ã€Œã€ã€ã€ï¼ˆï¼‰()ã€ã€‘ã€Šã€‹ã€ˆã€‰â€œâ€"'`,.?!;:]/g,"").toLowerCase().trim(); }
    function uuid(){ return "b" + Math.random().toString(36).slice(2,9); }

    // ======== ç•«é¢æ›´æ–° ========
    function updateTop(){
      document.getElementById("bankBtn").textContent = "é¡Œåº«ï¼š" + (currentBankKey ? (NAMES[currentBankKey]||currentBankKey) : "æœªé¸æ“‡");
      document.getElementById("remaining").textContent = remaining.length;
      const sc = SCORES[currentBankKey] || {correct:0, attempts:0};
      const pct = sc.attempts ? Math.round(sc.correct*100/sc.attempts) : 0;
      document.getElementById("score").textContent = `é€šéç‡ï¼š${sc.correct}/${sc.attempts}ï¼ˆ${pct}%ï¼‰`;
    }
    function setHint(text, cls="muted"){
      const el = document.getElementById("hint");
      el.textContent = text; el.className = "hint " + cls;
    }
    function showWord(text){ document.getElementById("word").textContent = text; }

    // ======== é¡Œåº«æ§åˆ¶ ========
    function setBank(key, fresh=true){
      currentBankKey = key;
      currentBank = (BANKS[key]||[]).slice();
      if(fresh){ remaining = shuffle(currentBank.slice()); currentWord=""; }
      nextWord();
      save(LS_PROGRESS, { key: currentBankKey, remaining, currentWord });
      updateTop();
    }
    function nextWord(){
      if(!currentBankKey){ showWord("è«‹é¸æ“‡é¡Œåº«"); setHint("æŒ‰ä¸‹ã€Œé–‹å§‹ã€å¾Œæ¸…æ¥šå¿µå‡ºè©èª"); return; }
      if(remaining.length===0){ showWord("å·²å®Œæˆæœ¬è¼ª"); setHint("æŒ‰ â‹¯ â†’ é‡æ’ æˆ– é‡ç½®é€²åº¦"); return; }
      currentWord = remaining.pop();
      showWord("è«‹èªªå‡ºï¼š" + currentWord);
      setHint("æŒ‰ã€Œé–‹å§‹ã€å¾Œæ¸…æ¥šå¿µå‡ºè©èª");
      updateTop();
      save(LS_PROGRESS, { key: currentBankKey, remaining, currentWord });
    }

    // ======== èªéŸ³è¾¨è­˜ ========
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if(!SpeechRecognition){ setHint("âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹æ”¹ç”¨ Chrome/Edgeã€‚","bad"); }
    else {
      recognition.lang = "zh-TW"; recognition.interimResults = false; recognition.maxAlternatives = 1;
      recognition.onstart = () => { listening = true; setHint("ğŸ¤ éŒ„éŸ³ä¸­â€¦è«‹å¿µå‡ºè©èª"); document.getElementById("startBtn").textContent = "åœæ­¢"; };
      recognition.onresult = (e) => {
        const raw = e.results[0][0].transcript || "";
        const said = normalize(raw), target = normalize(currentWord);
        if(!SCORES[currentBankKey]) SCORES[currentBankKey] = {correct:0, attempts:0};
        SCORES[currentBankKey].attempts += 1;
        if(said === target && target.length>0){
          SCORES[currentBankKey].correct += 1;
          setHint("âœ… ç­”å°äº†ï¼","ok");
          setTimeout(nextWord, 800);
        } else {
          setHint(`âŒ å†è©¦ä¸€æ¬¡`,"bad");
        }
        save(LS_SCORES, SCORES);
        updateTop();
      };
      recognition.onerror = (e) => { setHint("âš ï¸ éŒ¯èª¤ï¼š" + e.error,"bad"); };
      recognition.onend = () => { listening = false; document.getElementById("startBtn").textContent = "é–‹å§‹"; };
    }

    // ======== äº‹ä»¶ ========
    document.getElementById("startBtn").addEventListener("click", ()=>{
      if(!recognition) return;
      if(!currentBankKey){ setHint("è«‹å…ˆé¸æ“‡é¡Œåº«","bad"); return; }
      if(listening){ try{ recognition.stop(); }catch(e){} }
      else { try{ recognition.start(); }catch(e){} }
    });
    document.getElementById("nextBtn").addEventListener("click", nextWord);
    document.getElementById("moreBtn").addEventListener("click", ()=> moreDlg.showModal());
    document.getElementById("bankBtn").addEventListener("click", ()=> bankDlg.showModal());

    // æ›´å¤šé¸å–®
    const moreDlg = document.getElementById("moreDlg");
    document.getElementById("moreClose").addEventListener("click", ()=> moreDlg.close());
    document.getElementById("reshuffleBtn").addEventListener("click", ()=>{ if(!currentBankKey) return; remaining = shuffle(currentBank.slice()); currentWord=""; nextWord(); });
    document.getElementById("resetProgressBtn").addEventListener("click", ()=>{ if(!currentBankKey) return; remaining = shuffle(BANKS[currentBankKey].slice()); currentWord=""; nextWord(); });
    document.getElementById("resetScoreBtn").addEventListener("click", ()=>{ if(!currentBankKey) return; if(!confirm("æ¸…ç©ºç›®å‰é¡Œåº«åˆ†æ•¸ï¼Ÿ")) return; SCORES[currentBankKey]={correct:0, attempts:0}; save(LS_SCORES, SCORES); updateTop(); setHint("å·²æ¸…ç©ºåˆ†æ•¸"); });

    // é¡Œåº«å°è©±æ¡†
    const bankDlg = document.getElementById("bankDlg");
    document.getElementById("dlgClose").addEventListener("click", ()=> bankDlg.close());
    const bankPills = document.getElementById("bankPills");
    const bankNameInput = document.getElementById("bankNameInput");
    const bankText = document.getElementById("bankText");
    let selectedKeyForEdit = null;

    function renderBankPills(){
      bankPills.innerHTML = "";
      Object.keys(BANKS).forEach(key=>{
        const pill = document.createElement("button");
        pill.className = "pill";
        pill.textContent = NAMES[key] || key;
        pill.addEventListener("click", ()=>{
          // åˆ‡æ›é¡Œåº«ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
          setBank(key);
          // åŒæ­¥åˆ°ç·¨è¼¯å€
          selectedKeyForEdit = key;
          bankNameInput.value = NAMES[key] || key;
          bankText.value = (BANKS[key]||[]).join(" ");
        });
        bankPills.appendChild(pill);
      });
      // é è¨­é¸ä¸­ç›®å‰é¡Œåº«
      if(currentBankKey){
        selectedKeyForEdit = currentBankKey;
        bankNameInput.value = NAMES[currentBankKey] || currentBankKey;
        bankText.value = (BANKS[currentBankKey]||[]).join(" ");
      } else {
        selectedKeyForEdit = null;
        bankNameInput.value = "";
        bankText.value = "";
      }
    }

    document.getElementById("saveNameBtn").addEventListener("click", ()=>{
      if(!selectedKeyForEdit) { alert("è«‹å…ˆé¸æ“‡é¡Œåº«"); return; }
      const newName = bankNameInput.value.trim() || selectedKeyForEdit;
      NAMES[selectedKeyForEdit] = newName;
      save(LS_NAMES, NAMES);
      document.getElementById("bankBtn").textContent = "é¡Œåº«ï¼š" + (NAMES[currentBankKey]||currentBankKey||"æœªé¸æ“‡");
      renderBankPills();
    });

    document.getElementById("saveBankBtn").addEventListener("click", ()=>{
      if(!selectedKeyForEdit) { alert("è«‹å…ˆé¸æ“‡é¡Œåº«"); return; }
      const words = splitWords(bankText.value);
      if(words.length===0){ alert("é¡Œåº«ä¸å¯ç‚ºç©º"); return; }
      BANKS[selectedKeyForEdit] = words;
      save(LS_BANKS, BANKS);
      if(currentBankKey===selectedKeyForEdit){ setBank(selectedKeyForEdit); }
      renderBankPills();
      setHint("å·²å„²å­˜å…§å®¹");
    });

    document.getElementById("resetBankBtn").addEventListener("click", ()=>{
      if(!selectedKeyForEdit) { alert("è«‹å…ˆé¸æ“‡é¡Œåº«"); return; }
      if(DEFAULT_BANKS[selectedKeyForEdit]){
        BANKS[selectedKeyForEdit] = DEFAULT_BANKS[selectedKeyForEdit].slice();
        save(LS_BANKS, BANKS);
        bankText.value = BANKS[selectedKeyForEdit].join(" ");
        if(currentBankKey===selectedKeyForEdit){ setBank(selectedKeyForEdit); }
        renderBankPills();
      } else {
        alert("æ­¤é¡Œåº«æ²’æœ‰é è¨­å…§å®¹");
      }
    });

    document.getElementById("deleteBankBtn").addEventListener("click", ()=>{
      if(!selectedKeyForEdit) { alert("è«‹å…ˆé¸æ“‡é¡Œåº«"); return; }
      if(!confirm("åˆªé™¤æ­¤é¡Œåº«ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;
      delete BANKS[selectedKeyForEdit];
      delete NAMES[selectedKeyForEdit];
      delete SCORES[selectedKeyForEdit];
      save(LS_BANKS, BANKS); save(LS_NAMES, NAMES); save(LS_SCORES, SCORES);
      if(currentBankKey===selectedKeyForEdit){ currentBankKey=null; currentBank=[]; remaining=[]; currentWord=""; showWord("è«‹é¸æ“‡é¡Œåº«"); }
      selectedKeyForEdit=null; bankNameInput.value=""; bankText.value="";
      renderBankPills(); updateTop();
    });

    document.getElementById("addBankBtn").addEventListener("click", ()=>{
      const nm = document.getElementById("newBankName").value.trim();
      if(!nm){ alert("è«‹è¼¸å…¥é¡Œåº«åç¨±"); return; }
      const key = uuid();
      BANKS[key]=["ç¤ºç¯„","è©èª"]; NAMES[key]=nm;
      save(LS_BANKS, BANKS); save(LS_NAMES, NAMES);
      document.getElementById("newBankName").value="";
      renderBankPills();
    });

    // ======== åˆå§‹åŒ– ========
    renderBankPills();
    const saved = load(LS_PROGRESS, null);
    if(saved && saved.key && BANKS[saved.key]){
      currentBankKey = saved.key;
      currentBank = BANKS[currentBankKey].slice();
      remaining = Array.isArray(saved.remaining) && saved.remaining.every(w=>currentBank.includes(w)) ? saved.remaining.slice() : shuffle(currentBank.slice());
      currentWord = saved.currentWord || "";
      if(currentWord){ showWord("è«‹èªªå‡ºï¼š" + currentWord); } else { nextWord(); }
    }
    updateTop();
  </script>
</body>
</html>
