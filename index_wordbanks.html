<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èªè©ç·´ç¿’éŠæˆ²ï¼ˆå¤šèªè©åº«ç‰ˆï¼‰</title>
  <style>
    :root { --gap: 14px; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; 
           text-align: center; padding: 40px 16px; }
    h1 { margin: 0 0 8px; font-size: 24px; }
    .subtitle { color:#666; margin-bottom: 20px; }
    .bank-row, .controls { display:flex; gap: var(--gap); justify-content:center; flex-wrap: wrap; margin: 12px 0; }
    button { font-size: 16px; padding: 10px 18px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; background: #fafafa; }
    button.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    #word { font-size: 32px; margin: 18px 0; }
    #status, #heard, #bankName { margin: 10px 0; font-size: 16px; }
    #status { min-height: 24px; }
    .ok { color: #16a34a; }
    .bad { color: #dc2626; }
    .muted { color: #6b7280; }
    .card { max-width: 680px; margin: 0 auto; border:1px solid #eee; border-radius: 16px; padding: 18px; box-shadow: 0 6px 16px rgba(0,0,0,.06); }
  </style>
</head>
<body>
  <div class="card">
    <h1>èªè©ç·´ç¿’éŠæˆ²</h1>
    <div class="subtitle">é¸æ“‡èªè©åº« â†’ æŒ‰ã€Œé–‹å§‹éŒ„éŸ³ã€â†’ èªªå‡ºç•«é¢é¡¯ç¤ºçš„è©èª</div>

    <div id="bankName" class="muted">ç›®å‰èªè©åº«ï¼šå°šæœªé¸æ“‡</div>
    <div class="bank-row">
      <button id="btnG3">G3L1</button>
      <button id="btnG4">G4L1</button>
    </div>

    <div id="word">è«‹å…ˆé¸æ“‡èªè©åº«</div>

    <div class="controls">
      <button id="nextBtn">ä¸‹ä¸€é¡Œ</button>
      <button id="startBtn" class="primary">é–‹å§‹éŒ„éŸ³</button>
      <button id="stopBtn">åœæ­¢éŒ„éŸ³</button>
    </div>

    <div id="status" class="muted"></div>
    <div id="heard" class="muted"></div>
  </div>

  <script>
    // ======== é¡Œåº«å®šç¾© ========
    const BANKS = {
      G3L1: ["æ†‚æ„","ç¦®è®“","è¼‰äºº","ç‘æ°´","å°èˆŸ","æ–‡å­—","å­¸ç¿’","ç·´ç¿’","ç›¸ä¼¼","å£è¨£","å¿Œå¦’","å˜†æ°£"],
      G4L1: ["è€³æœµ","æºœå†°","ä¸€ä¸²","æ°´ç ","é’è›™","æ¸¸æ³³","ç…©æƒ±","è½‰èº«","é™€èº","ç·©æ…¢","æ»‘å€’","è€é·¹"]
    };

    let currentBankKey = null;
    let currentBank = [];
    let currentWord = "";
    let listening = false;

    // ======== å·¥å…·å‡½å¼ ========
    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    // æ­£è¦åŒ–ï¼šç§»é™¤ä¸­/è¥¿æ¨™é»ã€ç©ºç™½ã€å…¨å½¢ç©ºç™½ï¼Œä¸¦è½‰å°å¯«ï¼ˆä»¥é˜²è‹±æ•¸æ··é›œæƒ…æ³ï¼‰
    function normalize(str){
      if(!str) return "";
      return str
        .replace(/[\u3000\s]/g, "")                       // ç©ºç™½èˆ‡å…¨å½¢ç©ºç™½
        .replace(/[ã€‚ï¼Œï¼ã€ï¼›ï¼šï¼Ÿï¼â€¦ã€Œã€ã€ã€ï¼ˆï¼‰()ã€ã€‘ã€Šã€‹ã€ˆã€‰â€œâ€"'`,.?!;:]/g, "") // å¸¸è¦‹æ¨™é»
        .toLowerCase()
        .trim();
    }

    function setBank(key){
      currentBankKey = key;
      currentBank = BANKS[key].slice(); // è¤‡è£½ä¸€ä»½
      document.getElementById("bankName").innerText = "ç›®å‰èªè©åº«ï¼š" + key;
      document.getElementById("status").innerText = "";
      newWord();
    }

    function newWord(){
      if(!currentBank.length){
        document.getElementById("word").innerText = "è«‹å…ˆé¸æ“‡èªè©åº«";
        return;
      }
      currentWord = pickRandom(currentBank);
      document.getElementById("word").innerText = "è«‹èªªå‡ºï¼š" + currentWord;
      document.getElementById("status").innerText = "è«‹æŒ‰ã€Œé–‹å§‹éŒ„éŸ³ã€ä¸¦æ¸…æ¥šå¿µå‡ºè©èª";
      document.getElementById("status").className = "muted";
      document.getElementById("heard").innerText = "";
    }

    // ======== Web Speech API åˆå§‹åŒ– ========
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition){
      document.getElementById("status").innerText = "âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹æ”¹ç”¨ Chrome æˆ– Edgeã€‚";
    }
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if(recognition){
      recognition.lang = "zh-TW";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.onstart = () => {
        listening = true;
        document.getElementById("status").innerText = "ğŸ¤ éŒ„éŸ³ä¸­â€¦è«‹å¿µå‡ºè©èª";
        document.getElementById("status").className = "muted";
      };

      recognition.onresult = (event) => {
        const raw = event.results[0][0].transcript || "";
        const transcript = normalize(raw);
        const target = normalize(currentWord);

        document.getElementById("heard").innerText = "æˆ‘è½åˆ°ä½ èªªï¼šã€Œ" + raw + "ã€";

        if (transcript === target && target.length > 0){
          document.getElementById("status").innerText = "âœ… å¤ªæ£’äº†ï¼ç­”å°äº†ï¼";
          document.getElementById("status").className = "ok";
        } else {
          document.getElementById("status").innerText = "âŒ å†è©¦ä¸€æ¬¡ï¼";
          document.getElementById("status").className = "bad";
        }
      };

      recognition.onerror = (event) => {
        document.getElementById("status").innerText = "âš ï¸ éŒ¯èª¤ï¼š" + event.error;
        document.getElementById("status").className = "bad";
      };

      recognition.onend = () => {
        listening = false;
      };
    }

    // ======== äº‹ä»¶ç¶å®š ========
    document.getElementById("btnG3").addEventListener("click", () => setBank("G3L1"));
    document.getElementById("btnG4").addEventListener("click", () => setBank("G4L1"));

    document.getElementById("nextBtn").addEventListener("click", () => {
      newWord();
    });

    document.getElementById("startBtn").addEventListener("click", () => {
      if(!recognition){ return; }
      if(!currentBankKey){
        document.getElementById("status").innerText = "è«‹å…ˆé¸æ“‡èªè©åº«ï¼ˆG3L1 æˆ– G4L1ï¼‰";
        document.getElementById("status").className = "bad";
        return;
      }
      if(!listening){
        try { recognition.start(); } catch(e){ /* é˜²æ­¢å¿«é€Ÿé€£é»éŒ¯èª¤ */ }
      }
    });

    document.getElementById("stopBtn").addEventListener("click", () => {
      if(recognition && listening){
        try { recognition.stop(); } catch(e){}
      }
    });
  </script>
</body>
</html>
