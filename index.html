<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>語詞練習遊戲（自訂題庫名稱＋通過率）</title>
  <style>
    :root { --gap: 14px; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; 
           text-align: center; padding: 40px 16px; background:#fbfbfb;}
    h1 { margin: 0 0 8px; font-size: 24px; }
    .subtitle { color:#666; margin-bottom: 20px; }
    .row, .controls, .bank-row { display:flex; gap: var(--gap); justify-content:center; flex-wrap: wrap; margin: 12px 0; }
    button { font-size: 16px; padding: 10px 18px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; background: #fff; }
    button.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    button.ghost { background:#fff; }
    button.warn { background:#f59e0b; color:#fff; border-color:#f59e0b; }
    button.danger { background:#ef4444; color:#fff; border-color:#ef4444; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    #word { font-size: 32px; margin: 18px 0; min-height: 48px; }
    #status, #heard, #bankName, #scoreboard { margin: 10px 0; font-size: 16px; }
    #status { min-height: 24px; }
    .ok { color: #16a34a; }
    .bad { color: #dc2626; }
    .muted { color: #6b7280; }
    .card { max-width: 980px; margin: 0 auto 20px; border:1px solid #eee; border-radius: 16px; padding: 18px; background:#fff; box-shadow: 0 6px 16px rgba(0,0,0,.06); }
    details { text-align: left; }
    textarea { width: 100%; min-height: 90px; border:1px solid #ddd; border-radius:10px; padding:10px; font-size: 14px; }
    .left { text-align:left; }
    .small { font-size:13px; color:#6b7280; }
    input[type="text"] { padding:8px 10px; border:1px solid #ddd; border-radius:10px; font-size:14px; }
    .bank-pill { display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border:1px solid #e5e7eb; border-radius:999px; background:#f8fafc; }
    .divider { height:1px; background:#eee; margin:12px 0; }
  </style>
</head>
<body>
  <div class="card">
    <h1>語詞練習遊戲</h1>
    <div class="subtitle">選擇題庫 → 按「開始錄音」→ 說出畫面顯示的詞語（隨機不重複）</div>

    <div id="bankName" class="muted">目前題庫：尚未選擇</div>
    <div id="scoreboard" class="small">通過率：0/0（0%）</div>

    <div class="bank-row" id="bankButtons"></div>

    <div id="word">請先選擇題庫</div>

    <div class="controls">
      <button id="nextBtn" class="ghost">下一題</button>
      <button id="startBtn" class="primary">開始錄音</button>
      <button id="stopBtn" class="ghost">停止錄音</button>
      <button id="reshuffleBtn" class="ghost">重排本輪</button>
      <button id="resetProgressBtn" class="warn">重置進度（本題庫）</button>
      <button id="resetScoreBtn" class="danger">清空分數（本題庫）</button>
    </div>

    <div id="status" class="muted"></div>
    <div id="heard" class="muted"></div>
    <div class="small">本輪剩餘題數：<span id="remainingCount">0</span></div>
  </div>

  <div class="card left">
    <h2 style="margin:0 0 8px">管理題庫（可自訂名稱）</h2>
    <div class="small">輸入方式：以空白、逗號或換行分隔；儲存後會保存在本機瀏覽器（localStorage）。</div>
    <div class="divider"></div>

    <div id="manageArea"></div>

    <div class="row" style="justify-content:flex-start">
      <input id="newBankName" type="text" placeholder="新增題庫名稱，如：G5L1 或 社會技巧A" />
      <button id="addBankBtn" class="primary">新增題庫</button>
    </div>
  </div>

  <script>
    // ======== 預設題庫與名稱 ========
    const DEFAULT_BANKS = {
      b1: ["憂愁","禮讓","載人","灑水","小舟","文字","學習","練習","相似","口訣","忌妒","嘆氣"],
      b2: ["耳朵","溜冰","一串","水珠","青蛙","游泳","煩惱","轉身","陀螺","緩慢","滑倒","老鷹"]
    };
    const DEFAULT_NAMES = { b1: "G3L1", b2: "G4L1" };

    // localStorage keys
    const LS_BANKS = "speech_custom_banks_v2";
    const LS_NAMES = "speech_custom_names_v2";
    const LS_PROGRESS = "speech_progress_v2";
    const LS_SCORES = "speech_scores_v2";

    // ======== 狀態 ========
    let BANKS = load(LS_BANKS, DEFAULT_BANKS);
    let NAMES = load(LS_NAMES, DEFAULT_NAMES);
    let SCORES = load(LS_SCORES, {}); // {bankKey:{correct, attempts}}
    let currentBankKey = null;
    let currentBank = [];
    let remaining = [];
    let currentWord = "";
    let listening = false;

    // ======== 小工具 ========
    function save(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
    function load(key, fallback){ try{ const s=localStorage.getItem(key); return s? JSON.parse(s): JSON.parse(JSON.stringify(fallback)); }catch(e){ return JSON.parse(JSON.stringify(fallback)); } }
    function shuffle(array){ for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; } return array; }
    function splitWords(text){ return text.split(/[，,\u3000\s\n\r]+/).map(w=>w.trim()).filter(Boolean); }
    function normalize(str){ return (str||"").replace(/[\u3000\s]/g,"").replace(/[。，．、；：？！…「」『』（）()【】《》〈〉“”"'`,.?!;:]/g,"").toLowerCase().trim(); }
    function uuid(){ return "b" + Math.random().toString(36).slice(2,9); }

    function updateRemainingCount(){ document.getElementById("remainingCount").innerText = remaining.length; }
    function updateScoreboard(){
      if(!currentBankKey){ document.getElementById("scoreboard").innerText = "通過率：0/0（0%）"; return; }
      const sc = SCORES[currentBankKey] || {correct:0, attempts:0};
      const pct = sc.attempts ? Math.round(sc.correct*100/sc.attempts) : 0;
      document.getElementById("scoreboard").innerText = `通過率：${sc.correct}/${sc.attempts}（${pct}%）`;
    }

    // ======== 題庫切換與出題 ========
    function setBank(key, fresh=true){
      currentBankKey = key;
      currentBank = (BANKS[key]||[]).slice();
      if(fresh){ remaining = shuffle(currentBank.slice()); currentWord=""; }
      document.getElementById("bankName").innerText = "目前題庫：" + (NAMES[key]||key);
      nextWord();
      updateRemainingCount();
      updateScoreboard();
      save(LS_PROGRESS, { key: currentBankKey, remaining, currentWord });
    }

    function nextWord(){
      if(!currentBankKey){ document.getElementById("word").innerText="請先選擇題庫"; return; }
      if(remaining.length===0){
        document.getElementById("word").innerText="🎉 本輪已完成所有題目！按「重排本輪」可再練一次。";
        document.getElementById("status").innerText="";
        document.getElementById("heard").innerText="";
        return;
      }
      currentWord = remaining.pop();
      document.getElementById("word").innerText = "請說出：" + currentWord;
      document.getElementById("status").innerText = "請按「開始錄音」並清楚念出詞語";
      document.getElementById("status").className = "muted";
      document.getElementById("heard").innerText = "";
      updateRemainingCount();
      save(LS_PROGRESS, { key: currentBankKey, remaining, currentWord });
    }

    // ======== 語音辨識 ========
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if(!SpeechRecognition){
      document.getElementById("status").innerText = "⚠️ 此瀏覽器不支援語音辨識，請改用 Chrome 或 Edge。";
    } else {
      recognition.lang = "zh-TW";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onstart = () => {
        listening = true;
        document.getElementById("status").innerText = "🎤 錄音中…請念出詞語";
        document.getElementById("status").className = "muted";
      };
      recognition.onresult = (event) => {
        const raw = event.results[0][0].transcript || "";
        const said = normalize(raw);
        const target = normalize(currentWord);
        document.getElementById("heard").innerText = "我聽到你說：「" + raw + "」";

        // 計分
        if(!SCORES[currentBankKey]) SCORES[currentBankKey] = {correct:0, attempts:0};
        SCORES[currentBankKey].attempts += 1;

        if(said === target && target.length>0){
          SCORES[currentBankKey].correct += 1;
          document.getElementById("status").innerText = "✅ 太棒了！答對了！";
          document.getElementById("status").className = "ok";
          setTimeout(nextWord, 1000);
        } else {
          document.getElementById("status").innerText = "❌ 再試一次！";
          document.getElementById("status").className = "bad";
        }
        save(LS_SCORES, SCORES);
        updateScoreboard();
      };
      recognition.onerror = (event) => {
        document.getElementById("status").innerText = "⚠️ 錯誤：" + event.error;
        document.getElementById("status").className = "bad";
      };
      recognition.onend = () => { listening = false; };
    }

    // ======== 產生題庫按鈕 ========
    function renderBankButtons(){
      const wrap = document.getElementById("bankButtons");
      wrap.innerHTML = "";
      Object.keys(BANKS).forEach(key => {
        const btn = document.createElement("button");
        btn.className = "bank-pill";
        btn.innerText = NAMES[key] || key;
        btn.addEventListener("click", ()=> setBank(key));
        wrap.appendChild(btn);
      });
    }

    // ======== 管理區（名稱與內容） ========
    function renderManageArea(){
      const m = document.getElementById("manageArea");
      m.innerHTML = "";
      Object.keys(BANKS).forEach(key => {
        const name = NAMES[key] || key;
        const section = document.createElement("details");
        section.open = false;

        const sum = document.createElement("summary");
        sum.innerHTML = `<b>${name}</b>（${key}）`;
        section.appendChild(sum);

        const nameRow = document.createElement("div");
        nameRow.className = "row";
        nameRow.style.justifyContent = "flex-start";
        nameRow.innerHTML = `
          <input type="text" id="nm_${key}" value="${name}"/>
          <button class="ghost" id="saveName_${key}">儲存名稱</button>
          <button class="danger" id="del_${key}">刪除此題庫</button>
        `;
        section.appendChild(nameRow);

        const ta = document.createElement("textarea");
        ta.id = "ta_"+key;
        ta.value = (BANKS[key]||[]).join(" ");
        section.appendChild(ta);

        const btnRow = document.createElement("div");
        btnRow.className = "row";
        btnRow.style.justifyContent = "flex-start";
        btnRow.innerHTML = `
          <button class="primary" id="save_${key}">儲存內容</button>
          <button class="ghost" id="reset_${key}">載入預設（若有）</button>
          <span class="small">（以空白、逗號或換行分隔）</span>
        `;
        section.appendChild(btnRow);

        m.appendChild(section);

        // 綁定事件
        document.getElementById("saveName_"+key).addEventListener("click", ()=>{
          const newName = document.getElementById("nm_"+key).value.trim() || key;
          NAMES[key] = newName;
          save(LS_NAMES, NAMES);
          renderBankButtons();
          document.getElementById("bankName").innerText = currentBankKey? ("目前題庫：" + (NAMES[currentBankKey]||currentBankKey)) : "目前題庫：尚未選擇";
          alert("已儲存名稱");
        });

        document.getElementById("save_"+key).addEventListener("click", ()=>{
          const words = splitWords(ta.value);
          if(words.length===0){ alert("題庫不可為空"); return; }
          BANKS[key] = words;
          save(LS_BANKS, BANKS);
          if(currentBankKey===key){ setBank(key); }
          alert("已儲存內容（本機）");
        });

        document.getElementById("reset_"+key).addEventListener("click", ()=>{
          if(DEFAULT_BANKS[key]){
            BANKS[key] = DEFAULT_BANKS[key].slice();
            save(LS_BANKS, BANKS);
            ta.value = BANKS[key].join(" ");
            if(currentBankKey===key){ setBank(key); }
          }else{
            alert("此題庫沒有預設內容");
          }
        });

        document.getElementById("del_"+key).addEventListener("click", ()=>{
          if(!confirm("確定要刪除題庫「"+(NAMES[key]||key)+"」？此動作無法復原。")) return;
          delete BANKS[key];
          delete NAMES[key];
          delete SCORES[key];
          save(LS_BANKS, BANKS);
          save(LS_NAMES, NAMES);
          save(LS_SCORES, SCORES);
          if(currentBankKey===key){ currentBankKey=null; remaining=[]; currentWord=""; document.getElementById("word").innerText="請先選擇題庫"; document.getElementById("bankName").innerText="目前題庫：尚未選擇"; updateScoreboard(); }
          renderBankButtons();
          renderManageArea();
        });
      });
    }

    // 新增題庫
    document.getElementById("addBankBtn").addEventListener("click", ()=>{
      const nm = document.getElementById("newBankName").value.trim();
      if(!nm){ alert("請先輸入題庫名稱"); return; }
      const key = uuid();
      BANKS[key] = ["示範","詞語"];
      NAMES[key] = nm;
      save(LS_BANKS, BANKS);
      save(LS_NAMES, NAMES);
      document.getElementById("newBankName").value = "";
      renderBankButtons();
      renderManageArea();
      alert("已新增題庫「"+nm+"」。請展開管理區編輯內容。");
    });

    // ======== 控制區事件 ========
    document.getElementById("nextBtn").addEventListener("click", nextWord);
    document.getElementById("startBtn").addEventListener("click", ()=>{ if(recognition && !listening){ try{ recognition.start(); }catch(e){} } });
    document.getElementById("stopBtn").addEventListener("click", ()=>{ if(recognition && listening){ try{ recognition.stop(); }catch(e){} } });
    document.getElementById("reshuffleBtn").addEventListener("click", ()=>{ if(!currentBankKey) return; remaining = shuffle(currentBank.slice()); currentWord=""; nextWord(); });
    document.getElementById("resetProgressBtn").addEventListener("click", ()=>{ if(!currentBankKey) return; remaining = shuffle(BANKS[currentBankKey].slice()); currentWord=""; nextWord(); });
    document.getElementById("resetScoreBtn").addEventListener("click", ()=>{
      if(!currentBankKey) return;
      if(!confirm("清空當前題庫的分數？")) return;
      SCORES[currentBankKey] = {correct:0, attempts:0};
      save(LS_SCORES, SCORES);
      updateScoreboard();
    });

    // ======== 初始化渲染與進度載入 ========
    renderBankButtons();
    renderManageArea();

    const saved = load(LS_PROGRESS, null);
    if(saved && saved.key && BANKS[saved.key]){
      currentBankKey = saved.key;
      currentBank = BANKS[currentBankKey].slice();
      remaining = Array.isArray(saved.remaining) && saved.remaining.every(w=>currentBank.includes(w)) ? saved.remaining.slice() : shuffle(currentBank.slice());
      currentWord = saved.currentWord || "";
      document.getElementById("bankName").innerText = "目前題庫：" + (NAMES[currentBankKey]||currentBankKey);
      if(currentWord){ document.getElementById("word").innerText = "請說出：" + currentWord; } else { nextWord(); }
      updateRemainingCount();
      updateScoreboard();
    }
  </script>
</body>
</html>
