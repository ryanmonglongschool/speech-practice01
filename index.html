<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>èªè©ç·´ç¿’éŠæˆ²ï¼ˆè‡ªè¨‚é¡Œåº«åç¨±ï¼‹é€šéç‡ï¼‰</title>
  <style>
    :root { --gap: 14px; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; 
           text-align: center; padding: 40px 16px; background:#fbfbfb;}
    h1 { margin: 0 0 8px; font-size: 24px; }
    .subtitle { color:#666; margin-bottom: 20px; }
    .row, .controls, .bank-row { display:flex; gap: var(--gap); justify-content:center; flex-wrap: wrap; margin: 12px 0; }
    button { font-size: 16px; padding: 10px 18px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; background: #fff; }
    button.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    button.ghost { background:#fff; }
    button.warn { background:#f59e0b; color:#fff; border-color:#f59e0b; }
    button.danger { background:#ef4444; color:#fff; border-color:#ef4444; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    #word { font-size: 32px; margin: 18px 0; min-height: 48px; }
    #status, #heard, #bankName, #scoreboard { margin: 10px 0; font-size: 16px; }
    #status { min-height: 24px; }
    .ok { color: #16a34a; }
    .bad { color: #dc2626; }
    .muted { color: #6b7280; }
    .card { max-width: 980px; margin: 0 auto 20px; border:1px solid #eee; border-radius: 16px; padding: 18px; background:#fff; box-shadow: 0 6px 16px rgba(0,0,0,.06); }
    details { text-align: left; }
    textarea { width: 100%; min-height: 90px; border:1px solid #ddd; border-radius:10px; padding:10px; font-size: 14px; }
    .left { text-align:left; }
    .small { font-size:13px; color:#6b7280; }
    input[type="text"] { padding:8px 10px; border:1px solid #ddd; border-radius:10px; font-size:14px; }
    .bank-pill { display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border:1px solid #e5e7eb; border-radius:999px; background:#f8fafc; }
    .divider { height:1px; background:#eee; margin:12px 0; }
  </style>
</head>
<body>
  <div class="card">
    <h1>èªè©ç·´ç¿’éŠæˆ²</h1>
    <div class="subtitle">é¸æ“‡é¡Œåº« â†’ æŒ‰ã€Œé–‹å§‹éŒ„éŸ³ã€â†’ èªªå‡ºç•«é¢é¡¯ç¤ºçš„è©èªï¼ˆéš¨æ©Ÿä¸é‡è¤‡ï¼‰</div>

    <div id="bankName" class="muted">ç›®å‰é¡Œåº«ï¼šå°šæœªé¸æ“‡</div>
    <div id="scoreboard" class="small">é€šéç‡ï¼š0/0ï¼ˆ0%ï¼‰</div>

    <div class="bank-row" id="bankButtons"></div>

    <div id="word">è«‹å…ˆé¸æ“‡é¡Œåº«</div>

    <div class="controls">
      <button id="nextBtn" class="ghost">ä¸‹ä¸€é¡Œ</button>
      <button id="startBtn" class="primary">é–‹å§‹éŒ„éŸ³</button>
      <button id="stopBtn" class="ghost">åœæ­¢éŒ„éŸ³</button>
      <button id="reshuffleBtn" class="ghost">é‡æ’æœ¬è¼ª</button>
      <button id="resetProgressBtn" class="warn">é‡ç½®é€²åº¦ï¼ˆæœ¬é¡Œåº«ï¼‰</button>
      <button id="resetScoreBtn" class="danger">æ¸…ç©ºåˆ†æ•¸ï¼ˆæœ¬é¡Œåº«ï¼‰</button>
    </div>

    <div id="status" class="muted"></div>
    <div id="heard" class="muted"></div>
    <div class="small">æœ¬è¼ªå‰©é¤˜é¡Œæ•¸ï¼š<span id="remainingCount">0</span></div>
  </div>

  <div class="card left">
    <h2 style="margin:0 0 8px">ç®¡ç†é¡Œåº«ï¼ˆå¯è‡ªè¨‚åç¨±ï¼‰</h2>
    <div class="small">è¼¸å…¥æ–¹å¼ï¼šä»¥ç©ºç™½ã€é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”ï¼›å„²å­˜å¾Œæœƒä¿å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚</div>
    <div class="divider"></div>

    <div id="manageArea"></div>

    <div class="row" style="justify-content:flex-start">
      <input id="newBankName" type="text" placeholder="æ–°å¢é¡Œåº«åç¨±ï¼Œå¦‚ï¼šG5L1 æˆ– ç¤¾æœƒæŠ€å·§A" />
      <button id="addBankBtn" class="primary">æ–°å¢é¡Œåº«</button>
    </div>
  </div>

  <script>
    // ======== é è¨­é¡Œåº«èˆ‡åç¨± ========
    const DEFAULT_BANKS = {
      b1: ["æ†‚æ„","ç¦®è®“","è¼‰äºº","ç‘æ°´","å°èˆŸ","æ–‡å­—","å­¸ç¿’","ç·´ç¿’","ç›¸ä¼¼","å£è¨£","å¿Œå¦’","å˜†æ°£"],
      b2: ["è€³æœµ","æºœå†°","ä¸€ä¸²","æ°´ç ","é’è›™","æ¸¸æ³³","ç…©æƒ±","è½‰èº«","é™€èº","ç·©æ…¢","æ»‘å€’","è€é·¹"]
    };
    const DEFAULT_NAMES = { b1: "G3L1", b2: "G4L1" };

    // localStorage keys
    const LS_BANKS = "speech_custom_banks_v2";
    const LS_NAMES = "speech_custom_names_v2";
    const LS_PROGRESS = "speech_progress_v2";
    const LS_SCORES = "speech_scores_v2";

    // ======== ç‹€æ…‹ ========
    let BANKS = load(LS_BANKS, DEFAULT_BANKS);
    let NAMES = load(LS_NAMES, DEFAULT_NAMES);
    let SCORES = load(LS_SCORES, {}); // {bankKey:{correct, attempts}}
    let currentBankKey = null;
    let currentBank = [];
    let remaining = [];
    let currentWord = "";
    let listening = false;

    // ======== å°å·¥å…· ========
    function save(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
    function load(key, fallback){ try{ const s=localStorage.getItem(key); return s? JSON.parse(s): JSON.parse(JSON.stringify(fallback)); }catch(e){ return JSON.parse(JSON.stringify(fallback)); } }
    function shuffle(array){ for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; } return array; }
    function splitWords(text){ return text.split(/[ï¼Œ,\u3000\s\n\r]+/).map(w=>w.trim()).filter(Boolean); }
    function normalize(str){ return (str||"").replace(/[\u3000\s]/g,"").replace(/[ã€‚ï¼Œï¼ã€ï¼›ï¼šï¼Ÿï¼â€¦ã€Œã€ã€ã€ï¼ˆï¼‰()ã€ã€‘ã€Šã€‹ã€ˆã€‰â€œâ€"'`,.?!;:]/g,"").toLowerCase().trim(); }
    function uuid(){ return "b" + Math.random().toString(36).slice(2,9); }

    function updateRemainingCount(){ document.getElementById("remainingCount").innerText = remaining.length; }
    function updateScoreboard(){
      if(!currentBankKey){ document.getElementById("scoreboard").innerText = "é€šéç‡ï¼š0/0ï¼ˆ0%ï¼‰"; return; }
      const sc = SCORES[currentBankKey] || {correct:0, attempts:0};
      const pct = sc.attempts ? Math.round(sc.correct*100/sc.attempts) : 0;
      document.getElementById("scoreboard").innerText = `é€šéç‡ï¼š${sc.correct}/${sc.attempts}ï¼ˆ${pct}%ï¼‰`;
    }

    // ======== é¡Œåº«åˆ‡æ›èˆ‡å‡ºé¡Œ ========
    function setBank(key, fresh=true){
      currentBankKey = key;
      currentBank = (BANKS[key]||[]).slice();
      if(fresh){ remaining = shuffle(currentBank.slice()); currentWord=""; }
      document.getElementById("bankName").innerText = "ç›®å‰é¡Œåº«ï¼š" + (NAMES[key]||key);
      nextWord();
      updateRemainingCount();
      updateScoreboard();
      save(LS_PROGRESS, { key: currentBankKey, remaining, currentWord });
    }

    function nextWord(){
      if(!currentBankKey){ document.getElementById("word").innerText="è«‹å…ˆé¸æ“‡é¡Œåº«"; return; }
      if(remaining.length===0){
        document.getElementById("word").innerText="ğŸ‰ æœ¬è¼ªå·²å®Œæˆæ‰€æœ‰é¡Œç›®ï¼æŒ‰ã€Œé‡æ’æœ¬è¼ªã€å¯å†ç·´ä¸€æ¬¡ã€‚";
        document.getElementById("status").innerText="";
        document.getElementById("heard").innerText="";
        return;
      }
      currentWord = remaining.pop();
      document.getElementById("word").innerText = "è«‹èªªå‡ºï¼š" + currentWord;
      document.getElementById("status").innerText = "è«‹æŒ‰ã€Œé–‹å§‹éŒ„éŸ³ã€ä¸¦æ¸…æ¥šå¿µå‡ºè©èª";
      document.getElementById("status").className = "muted";
      document.getElementById("heard").innerText = "";
      updateRemainingCount();
      save(LS_PROGRESS, { key: currentBankKey, remaining, currentWord });
    }

    // ======== èªéŸ³è¾¨è­˜ ========
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if(!SpeechRecognition){
      document.getElementById("status").innerText = "âš ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ï¼Œè«‹æ”¹ç”¨ Chrome æˆ– Edgeã€‚";
    } else {
      recognition.lang = "zh-TW";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.onstart = () => {
        listening = true;
        document.getElementById("status").innerText = "ğŸ¤ éŒ„éŸ³ä¸­â€¦è«‹å¿µå‡ºè©èª";
        document.getElementById("status").className = "muted";
      };
      recognition.onresult = (event) => {
        const raw = event.results[0][0].transcript || "";
        const said = normalize(raw);
        const target = normalize(currentWord);
        document.getElementById("heard").innerText = "æˆ‘è½åˆ°ä½ èªªï¼šã€Œ" + raw + "ã€";

        // è¨ˆåˆ†
        if(!SCORES[currentBankKey]) SCORES[currentBankKey] = {correct:0, attempts:0};
        SCORES[currentBankKey].attempts += 1;

        if(said === target && target.length>0){
          SCORES[currentBankKey].correct += 1;
          document.getElementById("status").innerText = "âœ… å¤ªæ£’äº†ï¼ç­”å°äº†ï¼";
          document.getElementById("status").className = "ok";
          setTimeout(nextWord, 1000);
        } else {
          document.getElementById("status").innerText = "âŒ å†è©¦ä¸€æ¬¡ï¼";
          document.getElementById("status").className = "bad";
        }
        save(LS_SCORES, SCORES);
        updateScoreboard();
      };
      recognition.onerror = (event) => {
        document.getElementById("status").innerText = "âš ï¸ éŒ¯èª¤ï¼š" + event.error;
        document.getElementById("status").className = "bad";
      };
      recognition.onend = () => { listening = false; };
    }

    // ======== ç”¢ç”Ÿé¡Œåº«æŒ‰éˆ• ========
    function renderBankButtons(){
      const wrap = document.getElementById("bankButtons");
      wrap.innerHTML = "";
      Object.keys(BANKS).forEach(key => {
        const btn = document.createElement("button");
        btn.className = "bank-pill";
        btn.innerText = NAMES[key] || key;
        btn.addEventListener("click", ()=> setBank(key));
        wrap.appendChild(btn);
      });
    }

    // ======== ç®¡ç†å€ï¼ˆåç¨±èˆ‡å…§å®¹ï¼‰ ========
    function renderManageArea(){
      const m = document.getElementById("manageArea");
      m.innerHTML = "";
      Object.keys(BANKS).forEach(key => {
        const name = NAMES[key] || key;
        const section = document.createElement("details");
        section.open = false;

        const sum = document.createElement("summary");
        sum.innerHTML = `<b>${name}</b>ï¼ˆ${key}ï¼‰`;
        section.appendChild(sum);

        const nameRow = document.createElement("div");
        nameRow.className = "row";
        nameRow.style.justifyContent = "flex-start";
        nameRow.innerHTML = `
          <input type="text" id="nm_${key}" value="${name}"/>
          <button class="ghost" id="saveName_${key}">å„²å­˜åç¨±</button>
          <button class="danger" id="del_${key}">åˆªé™¤æ­¤é¡Œåº«</button>
        `;
        section.appendChild(nameRow);

        const ta = document.createElement("textarea");
        ta.id = "ta_"+key;
        ta.value = (BANKS[key]||[]).join(" ");
        section.appendChild(ta);

        const btnRow = document.createElement("div");
        btnRow.className = "row";
        btnRow.style.justifyContent = "flex-start";
        btnRow.innerHTML = `
          <button class="primary" id="save_${key}">å„²å­˜å…§å®¹</button>
          <button class="ghost" id="reset_${key}">è¼‰å…¥é è¨­ï¼ˆè‹¥æœ‰ï¼‰</button>
          <span class="small">ï¼ˆä»¥ç©ºç™½ã€é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”ï¼‰</span>
        `;
        section.appendChild(btnRow);

        m.appendChild(section);

        // ç¶å®šäº‹ä»¶
        document.getElementById("saveName_"+key).addEventListener("click", ()=>{
          const newName = document.getElementById("nm_"+key).value.trim() || key;
          NAMES[key] = newName;
          save(LS_NAMES, NAMES);
          renderBankButtons();
          document.getElementById("bankName").innerText = currentBankKey? ("ç›®å‰é¡Œåº«ï¼š" + (NAMES[currentBankKey]||currentBankKey)) : "ç›®å‰é¡Œåº«ï¼šå°šæœªé¸æ“‡";
          alert("å·²å„²å­˜åç¨±");
        });

        document.getElementById("save_"+key).addEventListener("click", ()=>{
          const words = splitWords(ta.value);
          if(words.length===0){ alert("é¡Œåº«ä¸å¯ç‚ºç©º"); return; }
          BANKS[key] = words;
          save(LS_BANKS, BANKS);
          if(currentBankKey===key){ setBank(key); }
          alert("å·²å„²å­˜å…§å®¹ï¼ˆæœ¬æ©Ÿï¼‰");
        });

        document.getElementById("reset_"+key).addEventListener("click", ()=>{
          if(DEFAULT_BANKS[key]){
            BANKS[key] = DEFAULT_BANKS[key].slice();
            save(LS_BANKS, BANKS);
            ta.value = BANKS[key].join(" ");
            if(currentBankKey===key){ setBank(key); }
          }else{
            alert("æ­¤é¡Œåº«æ²’æœ‰é è¨­å…§å®¹");
          }
        });

        document.getElementById("del_"+key).addEventListener("click", ()=>{
          if(!confirm("ç¢ºå®šè¦åˆªé™¤é¡Œåº«ã€Œ"+(NAMES[key]||key)+"ã€ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;
          delete BANKS[key];
          delete NAMES[key];
          delete SCORES[key];
          save(LS_BANKS, BANKS);
          save(LS_NAMES, NAMES);
          save(LS_SCORES, SCORES);
          if(currentBankKey===key){ currentBankKey=null; remaining=[]; currentWord=""; document.getElementById("word").innerText="è«‹å…ˆé¸æ“‡é¡Œåº«"; document.getElementById("bankName").innerText="ç›®å‰é¡Œåº«ï¼šå°šæœªé¸æ“‡"; updateScoreboard(); }
          renderBankButtons();
          renderManageArea();
        });
      });
    }

    // æ–°å¢é¡Œåº«
    document.getElementById("addBankBtn").addEventListener("click", ()=>{
      const nm = document.getElementById("newBankName").value.trim();
      if(!nm){ alert("è«‹å…ˆè¼¸å…¥é¡Œåº«åç¨±"); return; }
      const key = uuid();
      BANKS[key] = ["ç¤ºç¯„","è©èª"];
      NAMES[key] = nm;
      save(LS_BANKS, BANKS);
      save(LS_NAMES, NAMES);
      document.getElementById("newBankName").value = "";
      renderBankButtons();
      renderManageArea();
      alert("å·²æ–°å¢é¡Œåº«ã€Œ"+nm+"ã€ã€‚è«‹å±•é–‹ç®¡ç†å€ç·¨è¼¯å…§å®¹ã€‚");
    });

    // ======== æ§åˆ¶å€äº‹ä»¶ ========
    document.getElementById("nextBtn").addEventListener("click", nextWord);
    document.getElementById("startBtn").addEventListener("click", ()=>{ if(recognition && !listening){ try{ recognition.start(); }catch(e){} } });
    document.getElementById("stopBtn").addEventListener("click", ()=>{ if(recognition && listening){ try{ recognition.stop(); }catch(e){} } });
    document.getElementById("reshuffleBtn").addEventListener("click", ()=>{ if(!currentBankKey) return; remaining = shuffle(currentBank.slice()); currentWord=""; nextWord(); });
    document.getElementById("resetProgressBtn").addEventListener("click", ()=>{ if(!currentBankKey) return; remaining = shuffle(BANKS[currentBankKey].slice()); currentWord=""; nextWord(); });
    document.getElementById("resetScoreBtn").addEventListener("click", ()=>{
      if(!currentBankKey) return;
      if(!confirm("æ¸…ç©ºç•¶å‰é¡Œåº«çš„åˆ†æ•¸ï¼Ÿ")) return;
      SCORES[currentBankKey] = {correct:0, attempts:0};
      save(LS_SCORES, SCORES);
      updateScoreboard();
    });

    // ======== åˆå§‹åŒ–æ¸²æŸ“èˆ‡é€²åº¦è¼‰å…¥ ========
    renderBankButtons();
    renderManageArea();

    const saved = load(LS_PROGRESS, null);
    if(saved && saved.key && BANKS[saved.key]){
      currentBankKey = saved.key;
      currentBank = BANKS[currentBankKey].slice();
      remaining = Array.isArray(saved.remaining) && saved.remaining.every(w=>currentBank.includes(w)) ? saved.remaining.slice() : shuffle(currentBank.slice());
      currentWord = saved.currentWord || "";
      document.getElementById("bankName").innerText = "ç›®å‰é¡Œåº«ï¼š" + (NAMES[currentBankKey]||currentBankKey);
      if(currentWord){ document.getElementById("word").innerText = "è«‹èªªå‡ºï¼š" + currentWord; } else { nextWord(); }
      updateRemainingCount();
      updateScoreboard();
    }
  </script>
</body>
</html>
